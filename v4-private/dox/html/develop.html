<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPQC-Docs: Using MPQC to Develop New Features</title>
<!--BEGIN PROJECT_ICON-->
<link rel="icon" href="$projecticon" type="image/x-icon" />
<!--END PROJECT_ICON-->
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--BEGIN COPY_CLIPBOARD-->
<script type="text/javascript" src="clipboard.js"></script>
<!--END COPY_CLIPBOARD-->
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init();
        DoxygenAwesomeParagraphLink.init();
    </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"$logosize/></td>
  <td id="projectalign">
   <div id="projectname">MPQC-Docs<span id="projectnumber">&#160;4.0.0-beta.1</span>
   </div>
   <div id="projectbrief">Massively Parallel Electronic Structure platform</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Using MPQC to Develop New Features</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>There are three modes in which MPQC can be used in developing software implementation of existing and new methods:</p><ul>
<li><b>native</b>: you develop within the MPQC source tree directly;</li>
<li><b>plug-in</b>: you plug your code into MPQC to extend its functionality, e.g. by adding new classes to MPQC;</li>
<li><b>plug-out</b>: you plug MPQC libraries into your project, e.g. by using MPQC classes and functions in your code.</li>
</ul>
<p>These methods are demonstrated and discussed below.</p><ul>
<li><a class="el" href="develop.html#develop-within-mpqc">Developing code within MPQC</a></li>
<li><a class="el" href="develop.html#extend-mpqc">Extending MPQC functionality</a><ul>
<li><a class="el" href="develop.html#devsampmp2">MP2 Implementation Example</a></li>
</ul>
</li>
<li><a class="el" href="develop.html#develop-outside-mpqc">Using MPQC as an external library in a separate project</a><ul>
<li><a class="el" href="develop.html#devsampaoints">AOInts Implementation Example</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="develop-within-mpqc"></a>
Developing code within MPQC</h1>
<p>This approach is useful when you want to extend and replace existing classes in MPQC, e.g. you want to add a new Wavefunction class that implements a new or existing electronic structure method.</p>
<p>The pros of this approach are:</p><ul>
<li>the user can take advantage of the MPQC infrastructure, e.g. the build system and test harness;</li>
<li>this approach makes it possible to eventually incorporate the new code into the MPQC master source repository for release and maintenance by the core MPQC team.</li>
</ul>
<p>The workflow for developing code within MPQC is based on pull requests, albeit it differs for core and non-core developers. Since MPQC is hosted on GitHub, we by default assume everyone will use the GitHub-provided mechanisms for working with pull requests. For more info see <a href="https://help.github.com/categories/collaborating-with-issues-and-pull-requests/">GitHub Help</a>.</p><ul>
<li>Core MPQC developers (e.g. anyone with write access to the private MPQC repo) are encouraged to use the <a href="https://help.github.com/articles/about-collaborative-development-models/">shared repository model</a>, i.e. create a feature branch (and create a pull request immediately), add/modify code, mark the pull request "ready to merge" when done, and respond to feedback (if any) before merging.</li>
<li>Others can use the <a href="https://help.github.com/articles/about-collaborative-development-models/">pull-and-fork model</a>.</li>
</ul>
<p>When you start working on a feature, it is recommended to <em>immediately</em> create a pull request. There are several reasons to do this.</p><ol type="1">
<li>This will advertise your work to the rest of the team and avoid duplicate effort by keeping everyone abreast of what's in the pipeline.</li>
<li>Others will be able to contribute to your work by pushing to your feature branch.</li>
<li>This will enable Continuous Integration tests to be done on your feature branch.</li>
</ol>
<p>You will want to periodically (i.e., <em>often</em>) sync with the changes in the main repo by merging in changes via the pull request mechanism or by direct git merge. When you are ready to merge your changes into the main repo create a pull request for code review and incorporation.</p>
<p>If you are a core MPQC developer or want to contribute your code to MPQC refer to <a class="el" href="contribguide.html">Contrubutor Guide</a> for more recommended practices.</p>
<h1><a class="anchor" id="extend-mpqc"></a>
Extending MPQC functionality</h1>
<p>It is also possible to extend the functionality of the MPQC executable by adding new classes. The <em>plug-in</em> style approach allows you to keep your source separate from the rest of the MPQC.</p>
<p>To use this approach it is necessary to compile MPQC libraries and install them to the location specifies by the <code>CMAKE_INSTALL_PREFIX</code> CMake variable. It is recommended that the MPQC is validated before installation.</p>
<h2><a class="anchor" id="devsampmp2"></a>
MP2 Implementation Example</h2>
<p>To illustrate how to use the plug-in approach let's consider a simple example in which we extend the MPQC executable with a new implementation of MP2 energy. Although MPQC has several implementations of MP2 already, they all assume canonical orbitals, and whereas our new formulation will not make this assumption by solving the MP1 amplitude equations iteratively.</p>
<h3><a class="anchor" id="devsampmp2src"></a>
MP2 Implementation Example: Source</h3>
<p>This example code illustrates a complete MP2 energy implementation using the MPQC Toolkit. The source file can be found at <a href="https://github.com/ValeevGroup/mpqc4/blob/master/doc/dev/examples/mp2/mp2.cpp"><code>doc/dev/examples/mp2/mp2.cpp</code></a> in the MPQC source directory. Note that the source file does not contain the <code><a class="el" href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a></code> function. Instead the MP2 class defined here will be linked into the MPQC executable and will become usable just like any other existing Wavefunction class in MPQC: you will be able to use it to compute gradients by finite differences, etc.</p>
<p>To compile the new class and link into the MPQC executable see the <a class="el" href="develop.html#devsampmp2mak">MP2 Implementation Example: CMakeLists.txt</a> section.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rhf_8h.html">mpqc/chemistry/qc/lcao/scf/rhf.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="lcao__wfn_8h.html">mpqc/chemistry/qc/lcao/wfn/lcao_wfn.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="energy_8h.html">mpqc/chemistry/qc/properties/energy.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="forcelink_8h.html">mpqc/util/keyval/forcelink.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacempqc.html">mpqc</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>LCAOWfn = <a class="code hl_class" href="classmpqc_1_1lcao_1_1_l_c_a_o_wavefunction.html">lcao::LCAOWavefunction&lt;TA::TensorD, TA::SparsePolicy&gt;</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This is a basic implementation of (iterative) MP2 energy.</span></div>
<div class="line"><span class="comment">// This is formulated in terms of occupied and unoccupied states represented</span></div>
<div class="line"><span class="comment">// as LCAOs, hence it&#39;s derived from LCAOWfn, aka ::mpqc::lcao::LCAOWavefunction</span></div>
<div class="line"><span class="comment">// .</span></div>
<div class="line"><span class="comment">// This class can only compute the energy, this is indicated by deriving it from</span></div>
<div class="line"><span class="comment">// Provides&lt;Energy&gt; (this introduces virtual methods can_evaluate() and</span></div>
<div class="line"><span class="comment">// evaluate() that specify, respectively, the ability to compute the energy and</span></div>
<div class="line"><span class="comment">// how the energy is computed).</span></div>
<div class="line"><span class="keyword">class </span>MP2 : <span class="keyword">public</span> LCAOWfn, <span class="keyword">public</span> <a class="code hl_class" href="classmpqc_1_1_provides.html">Provides</a>&lt;Energy&gt; {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="comment">// a few abbreviations to make the code less verbose</span></div>
<div class="line">  <span class="keyword">using </span>Array = TA::DistArray&lt;TA::TensorD, TA::SparsePolicy&gt;;</div>
<div class="line">  <span class="keyword">using </span>RHF = <a class="code hl_class" href="classmpqc_1_1lcao_1_1_r_h_f.html">lcao::RHF&lt;TA::TensorD, TA::SparsePolicy&gt;</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// the KeyVal constructor takes a KeyVal object that represents a keyword</span></div>
<div class="line">  <span class="comment">// group of the input file that corresponds to this object (see the &quot;mp2&quot;</span></div>
<div class="line">  <span class="comment">// group in the mp2.json file that accompanies this example).</span></div>
<div class="line">  <span class="comment">// The Keyval object will be queried for all keywords needed by</span></div>
<div class="line">  <span class="comment">// the KeyVal ctor of LCAOWfn, as well as keyword &quot;ref&quot; that specifies</span></div>
<div class="line">  <span class="comment">// the reference wave function.</span></div>
<div class="line">  MP2(<span class="keyword">const</span> <a class="code hl_class" href="classmpqc_1_1_key_val.html">KeyVal</a>&amp; kv) : LCAOWfn(kv) {</div>
<div class="line">    ref_wfn_ = kv.<a class="code hl_function" href="classmpqc_1_1_key_val.html#ac275bf6c01bfab2e5e7d9afd839140cc">object</a>&lt;RHF&gt;(<span class="stringliteral">&quot;ref&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!ref_wfn_)</div>
<div class="line">      <span class="keywordflow">throw</span> <a class="code hl_class" href="classmpqc_1_1_input_error.html">InputError</a>(<span class="stringliteral">&quot;missing reference RHF wave function&quot;</span>, __FILE__,</div>
<div class="line">                       __LINE__, <span class="stringliteral">&quot;ref&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  <span class="comment">// This implements the Energy::Provider::can_evaluate() virtual</span></div>
<div class="line">  <span class="comment">// function. This function returns true is the energy object can be computed.</span></div>
<div class="line">  <span class="keywordtype">bool</span> can_evaluate(<a class="code hl_class" href="classmpqc_1_1_energy.html">Energy</a>* energy)<span class="keyword"> override </span>{</div>
<div class="line">    <span class="comment">// can only compute energies (not forces (energy-&gt;order() == 1),</span></div>
<div class="line">    <span class="comment">// hessians, or higher derivatives)</span></div>
<div class="line">    <span class="keywordflow">return</span> energy-&gt;<a class="code hl_function" href="classmpqc_1_1math_1_1_taylor_expansion_function.html#a158e71d5c293c04144cd52ab2c96ae33">order</a>() == 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// This implements the Energy::Provider::evaluate() virtual function.</span></div>
<div class="line">  <span class="comment">// This function computes the MP2 energy and assigns it to the Energy object.</span></div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="group___util_misc_property_provider.html#ga7693c69595187e4e6cb49f5f9a3c396a">evaluate</a>(<a class="code hl_class" href="classmpqc_1_1_energy.html">Energy</a>* energy)<span class="keyword"> override </span>{</div>
<div class="line">    <span class="comment">// how precisely to compute the energy</span></div>
<div class="line">    <span class="keyword">auto</span> target_precision = energy-&gt;<a class="code hl_function" href="classmpqc_1_1math_1_1_taylor_expansion_function.html#a81967e3dbce35635438139d388e00c07">target_precision</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// if has not been computed to the desired precision</span></div>
<div class="line">    <span class="comment">// (or never computed at all) ...</span></div>
<div class="line">    <span class="keywordflow">if</span> (computed_precision_ &gt; target_precision) {</div>
<div class="line">      <span class="comment">// compute reference to higher precision than this wfn</span></div>
<div class="line">      <span class="keyword">auto</span> target_ref_precision =</div>
<div class="line">          this-&gt;target_to_ref_energy_precision(target_precision);</div>
<div class="line">      <span class="keyword">auto</span> ref_energy =</div>
<div class="line">          std::make_shared&lt;Energy&gt;(ref_wfn_, target_ref_precision);</div>
<div class="line">      ref_wfn_-&gt;evaluate(ref_energy.get());</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// use the reference orbitals to populate the orbital space registry</span></div>
<div class="line">      init_sdref(ref_wfn_, target_ref_precision);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// this actually computes the energy</span></div>
<div class="line">      <span class="keywordtype">double</span> mp2_corr_energy = compute_mp2_energy(target_precision);</div>
<div class="line"> </div>
<div class="line">      energy_ = ref_energy-&gt;energy() + mp2_corr_energy;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// commit the result to energy</span></div>
<div class="line">    this-&gt;set_value(energy, energy_);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// This function actually solves the MP1 equations and returns the MP2 energy.</span></div>
<div class="line">  <span class="keywordtype">double</span> compute_mp2_energy(<span class="keywordtype">double</span> target_precision) {</div>
<div class="line">    <span class="comment">// fac is an LCAOFactory object which evaluates integrals in terms of AOs</span></div>
<div class="line">    <span class="comment">// and LCAOs</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; fac = this-&gt;<a class="code hl_function" href="namespacempqc_1_1python_1_1wfn.html#a7ffe093899ab36aa030acff882148cb6">lcao_factory</a>();</div>
<div class="line">    <span class="keyword">auto</span>&amp; world = fac.world();</div>
<div class="line">    <span class="comment">// ofac is an OrbitalSpaceRegistry that defines the LCAO spaces that fac can</span></div>
<div class="line">    <span class="comment">// use ofac was populated by the init_sdref() call above</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; ofac = fac.orbital_registry();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> <a class="code hl_function" href="namespacempqc.html#afa2c03b81aadce4ea1aabb0ba2860cc2">nocc</a> = ofac.retrieve(<span class="stringliteral">&quot;m&quot;</span>)-&gt;rank();</div>
<div class="line">    <span class="keyword">auto</span> nocc_act = ofac.retrieve(<span class="stringliteral">&quot;i&quot;</span>)-&gt;rank();</div>
<div class="line">    <span class="keyword">auto</span> nvir = ofac.retrieve(<span class="stringliteral">&quot;a&quot;</span>)-&gt;rank();</div>
<div class="line">    <span class="keyword">auto</span> nfzc = <a class="code hl_function" href="namespacempqc.html#afa2c03b81aadce4ea1aabb0ba2860cc2">nocc</a> - nocc_act;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> F = fac.compute(L<span class="stringliteral">&quot;(p|F|q)&quot;</span>);</div>
<div class="line">    Eigen::VectorXd eps_p = math::array_to_eigen(F).diagonal();</div>
<div class="line">    <span class="comment">// replicated diagonal elements of Fo</span></div>
<div class="line">    <span class="keyword">auto</span> eps_o = eps_p.segment(nfzc, nocc_act);</div>
<div class="line">    <span class="comment">// replicated diagonal elements of Fv</span></div>
<div class="line">    <span class="keyword">auto</span> eps_v = eps_p.tail(nvir);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// G_iajb</span></div>
<div class="line">    <span class="keyword">auto</span> G = fac.compute(L<span class="stringliteral">&quot;(i a|G|j b)&quot;</span>);</div>
<div class="line">    <span class="comment">// Fij</span></div>
<div class="line">    <span class="keyword">auto</span> Fo = fac.compute(L<span class="stringliteral">&quot;(i|F|j)&quot;</span>);</div>
<div class="line">    <span class="comment">// Fab</span></div>
<div class="line">    <span class="keyword">auto</span> Fv = fac.compute(L<span class="stringliteral">&quot;(a|F|b)&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// zero out amplitudes</span></div>
<div class="line">    <span class="keywordflow">if</span> (!T_.is_initialized()) {</div>
<div class="line">      T_ = <a class="code hl_typedef" href="namespacempqc_1_1lcao_1_1pno.html#aca75fda259db2f33dd3cea93e42e57e6">Array</a>(world, G.trange(), G.shape());</div>
<div class="line">      T_.fill(0.0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// lambda function will be used to do a Jacobi update of the residual</span></div>
<div class="line">    <span class="keyword">auto</span> <a class="code hl_function" href="namespacempqc_1_1lcao_1_1cc_1_1detail.html#ac27fc2b04dcb6e693e9d46988fbc4676">jacobi_update</a> = [eps_o, eps_v](TA::TensorD&amp; result_tile) {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; range = result_tile.range();</div>
<div class="line">      <span class="keywordtype">double</span> <a class="code hl_function" href="namespacempqc_1_1lcao_1_1f12_1_1detail.html#a535e5eb60efb5e9a44087e975f4be2a0">norm</a> = 0.0;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; i : range) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> result_abij = result_tile[i] / (eps_o[i[0]] - eps_v[i[1]] +</div>
<div class="line">                                                   eps_o[i[2]] - eps_v[i[3]]);</div>
<div class="line">        result_tile[i] = result_abij;</div>
<div class="line">        <a class="code hl_function" href="namespacempqc_1_1lcao_1_1f12_1_1detail.html#a535e5eb60efb5e9a44087e975f4be2a0">norm</a> += result_abij * result_abij;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">return</span> std::sqrt(norm);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// solve the MP1 equations</span></div>
<div class="line">    <span class="keyword">auto</span> converged = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keyword">auto</span> iter = 0;</div>
<div class="line">    <span class="keyword">auto</span> energy = +1.0;</div>
<div class="line">    ExEnv::out0() &lt;&lt; <span class="stringliteral">&quot;Start solving MP2 Energy\n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">while</span> (not converged) {</div>
<div class="line">      <a class="code hl_typedef" href="namespacempqc_1_1lcao_1_1pno.html#aca75fda259db2f33dd3cea93e42e57e6">Array</a> R;</div>
<div class="line">      R(<span class="stringliteral">&quot;i,a,j,b&quot;</span>) = G(<span class="stringliteral">&quot;i,a,j,b&quot;</span>) + Fv(<span class="stringliteral">&quot;a,c&quot;</span>) * T_(<span class="stringliteral">&quot;i,c,j,b&quot;</span>) +</div>
<div class="line">                     Fv(<span class="stringliteral">&quot;b,c&quot;</span>) * T_(<span class="stringliteral">&quot;i,a,j,c&quot;</span>) - Fo(<span class="stringliteral">&quot;i,k&quot;</span>) * T_(<span class="stringliteral">&quot;k,a,j,b&quot;</span>) -</div>
<div class="line">                     Fo(<span class="stringliteral">&quot;j,k&quot;</span>) * T_(<span class="stringliteral">&quot;i,a,k,b&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// estimate the MP2 energy ... the Hylleraas formula is quadratic in error</span></div>
<div class="line">      <span class="keywordtype">double</span> updated_energy =</div>
<div class="line">          (G(<span class="stringliteral">&quot;i,a,j,b&quot;</span>) + R(<span class="stringliteral">&quot;i,a,j,b&quot;</span>)).dot(2 * T_(<span class="stringliteral">&quot;i,a,j,b&quot;</span>) - T_(<span class="stringliteral">&quot;i,b,j,a&quot;</span>));</div>
<div class="line">      ExEnv::out0() &lt;&lt; <a class="code hl_function" href="namespacempqc.html#aaa3f73986ae03e52631704f309d40bf7">indent</a> &lt;&lt; <span class="stringliteral">&quot;Iteration: &quot;</span> &lt;&lt; iter</div>
<div class="line">                    &lt;&lt; <span class="stringliteral">&quot; Energy: &quot;</span> &lt;&lt; updated_energy &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      computed_precision_ = std::abs(updated_energy - energy);</div>
<div class="line">      energy = updated_energy;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// update the amplitudes, if needed</span></div>
<div class="line">      converged = computed_precision_ &lt;= target_precision;</div>
<div class="line">      <span class="keywordflow">if</span> (not converged) {</div>
<div class="line">        <span class="comment">// R^{ij}_{ab} -&gt; R^{ij}_{ab} / (F^i_i + F^j_j - F^a_a - F^b_b)</span></div>
<div class="line">        TA::foreach_inplace(R, jacobi_update);</div>
<div class="line">        <span class="comment">// need a fence here since foreach_inplace mutates the contents of R</span></div>
<div class="line">        <span class="comment">// as a side effect.</span></div>
<div class="line">        <span class="comment">// N.B. most TiledArray ops will not need a fence (except to control</span></div>
<div class="line">        <span class="comment">//      the resource use)</span></div>
<div class="line">        world.gop.fence();</div>
<div class="line">        T_(<span class="stringliteral">&quot;i,a,j,b&quot;</span>) += R(<span class="stringliteral">&quot;i,a,j,b&quot;</span>);</div>
<div class="line">        ++iter;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> energy;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// This reimplements the ::mpqc::Wavefunction::obsolete() virtual function.</span></div>
<div class="line">  <span class="comment">// It gets called when, for example, the atomic positions get updated in</span></div>
<div class="line">  <span class="comment">// geometry optimization.</span></div>
<div class="line">  <span class="keywordtype">void</span> obsolete()<span class="keyword"> override </span>{</div>
<div class="line">    LCAOWfn::obsolete();</div>
<div class="line">    ref_wfn_-&gt;obsolete();</div>
<div class="line">    computed_precision_ = std::numeric_limits&lt;double&gt;::max();</div>
<div class="line">    energy_ = 0.0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  std::shared_ptr&lt;RHF&gt; ref_wfn_;</div>
<div class="line">  <a class="code hl_typedef" href="namespacempqc_1_1lcao_1_1pno.html#aca75fda259db2f33dd3cea93e42e57e6">Array</a> T_;</div>
<div class="line">  <span class="keywordtype">double</span> computed_precision_ = std::numeric_limits&lt;double&gt;::max();</div>
<div class="line">  <span class="keywordtype">double</span> energy_ = 0.0;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This macro registers the KeyVal constructor of our MP2 class and associates</span></div>
<div class="line"><span class="comment">// it with the &quot;MP2&quot; key, so that the KeyVal class knows how to find it when it</span></div>
<div class="line"><span class="comment">// finds this key as the object type in the user input.</span></div>
<div class="line"><a class="code hl_define" href="forcelink_8h.html#a837d2c91108e8f94b86681d7d6eddd94">MPQC_CLASS_EXPORT2</a>(<span class="stringliteral">&quot;MP2&quot;</span>, MP2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Creating this variable forces the code for the MP2 class to be linked into</span></div>
<div class="line"><span class="comment">// the mp2 executable (otherwise the MPQC main function will not see any</span></div>
<div class="line"><span class="comment">// references to this class and thus the linker will simply skip it).</span></div>
<div class="line"><a class="code hl_class" href="classmpqc_1_1detail_1_1_force_link.html">mpqc::detail::ForceLink&lt;MP2&gt;</a> fl;</div>
<div class="ttc" id="aclassmpqc_1_1_energy_html"><div class="ttname"><a href="classmpqc_1_1_energy.html">mpqc::Energy</a></div><div class="ttdoc">Taylor expansion of the molecular energy computed by a Wavefunction.</div><div class="ttdef"><b>Definition</b> energy.h:14</div></div>
<div class="ttc" id="aclassmpqc_1_1_input_error_html"><div class="ttname"><a href="classmpqc_1_1_input_error.html">mpqc::InputError</a></div><div class="ttdef"><b>Definition</b> exception.h:179</div></div>
<div class="ttc" id="aclassmpqc_1_1_key_val_html"><div class="ttname"><a href="classmpqc_1_1_key_val.html">mpqc::KeyVal</a></div><div class="ttdoc">KeyVal specifies C++ primitive data (booleans, integers, reals, string) and user-defined objects obta...</div><div class="ttdef"><b>Definition</b> keyval.h:474</div></div>
<div class="ttc" id="aclassmpqc_1_1_key_val_html_ac275bf6c01bfab2e5e7d9afd839140cc"><div class="ttname"><a href="classmpqc_1_1_key_val.html#ac275bf6c01bfab2e5e7d9afd839140cc">mpqc::KeyVal::object</a></div><div class="ttdeci">std::shared_ptr&lt; T &gt; object(const key_type &amp;path=key_type(), bool bypass_registry=false, bool disable_bad_input=false, bool exact_type=false) const</div><div class="ttdoc">return a pointer to an object at the given path</div><div class="ttdef"><b>Definition</b> keyval.h:1262</div></div>
<div class="ttc" id="aclassmpqc_1_1_provides_html"><div class="ttname"><a href="classmpqc_1_1_provides.html">mpqc::Provides</a></div><div class="ttdoc">Base for classes that provide Properties .</div><div class="ttdef"><b>Definition</b> provider.h:52</div></div>
<div class="ttc" id="aclassmpqc_1_1detail_1_1_force_link_html"><div class="ttname"><a href="classmpqc_1_1detail_1_1_force_link.html">mpqc::detail::ForceLink</a></div><div class="ttdoc">This, together with ForceLinkBase, is used to force code for particular classes to be linked into exe...</div><div class="ttdef"><b>Definition</b> forcelink.h:50</div></div>
<div class="ttc" id="aclassmpqc_1_1lcao_1_1_l_c_a_o_wavefunction_html"><div class="ttname"><a href="classmpqc_1_1lcao_1_1_l_c_a_o_wavefunction.html">mpqc::lcao::LCAOWavefunction</a></div><div class="ttdoc">LCAOWavefunction is a Wavefunction with an LCAOFactory.</div><div class="ttdef"><b>Definition</b> lcao_wfn.h:38</div></div>
<div class="ttc" id="aclassmpqc_1_1lcao_1_1_r_h_f_html"><div class="ttname"><a href="classmpqc_1_1lcao_1_1_r_h_f.html">mpqc::lcao::RHF</a></div><div class="ttdef"><b>Definition</b> rhf.h:21</div></div>
<div class="ttc" id="aclassmpqc_1_1math_1_1_taylor_expansion_function_html_a158e71d5c293c04144cd52ab2c96ae33"><div class="ttname"><a href="classmpqc_1_1math_1_1_taylor_expansion_function.html#a158e71d5c293c04144cd52ab2c96ae33">mpqc::math::TaylorExpansionFunction::order</a></div><div class="ttdeci">size_t order() const</div><div class="ttdef"><b>Definition</b> taylor.h:150</div></div>
<div class="ttc" id="aclassmpqc_1_1math_1_1_taylor_expansion_function_html_a81967e3dbce35635438139d388e00c07"><div class="ttname"><a href="classmpqc_1_1math_1_1_taylor_expansion_function.html#a81967e3dbce35635438139d388e00c07">mpqc::math::TaylorExpansionFunction::target_precision</a></div><div class="ttdeci">double target_precision(size_t ord) const</div><div class="ttdef"><b>Definition</b> taylor.h:154</div></div>
<div class="ttc" id="aenergy_8h_html"><div class="ttname"><a href="energy_8h.html">energy.h</a></div></div>
<div class="ttc" id="aforcelink_8h_html"><div class="ttname"><a href="forcelink_8h.html">forcelink.h</a></div></div>
<div class="ttc" id="aforcelink_8h_html_a837d2c91108e8f94b86681d7d6eddd94"><div class="ttname"><a href="forcelink_8h.html#a837d2c91108e8f94b86681d7d6eddd94">MPQC_CLASS_EXPORT2</a></div><div class="ttdeci">#define MPQC_CLASS_EXPORT2(K,...)</div><div class="ttdef"><b>Definition</b> forcelink.h:110</div></div>
<div class="ttc" id="agroup___util_misc_property_provider_html_ga7693c69595187e4e6cb49f5f9a3c396a"><div class="ttname"><a href="group___util_misc_property_provider.html#ga7693c69595187e4e6cb49f5f9a3c396a">mpqc::evaluate</a></div><div class="ttdeci">std::enable_if_t&lt;(detail::has_provider&lt; Property &gt;::value &amp;&amp;!std::is_const&lt; Property &gt;::value), void &gt; evaluate(Property &amp;property, Provider &amp;&amp;provider, EvaluateArgs... eval_args)</div><div class="ttdoc">Evaluates property using provider.</div><div class="ttdef"><b>Definition</b> provider.h:133</div></div>
<div class="ttc" id="alcao__wfn_8h_html"><div class="ttname"><a href="lcao__wfn_8h.html">lcao_wfn.h</a></div></div>
<div class="ttc" id="anamespacempqc_1_1lcao_1_1cc_1_1detail_html_ac27fc2b04dcb6e693e9d46988fbc4676"><div class="ttname"><a href="namespacempqc_1_1lcao_1_1cc_1_1detail.html#ac27fc2b04dcb6e693e9d46988fbc4676">mpqc::lcao::cc::detail::jacobi_update</a></div><div class="ttdeci">TA::DistArray&lt; Tile, Policy &gt; jacobi_update(const TA::DistArray&lt; Tile, Policy &gt; &amp;r, const EigenVector&lt; typename Tile::scalar_type &gt; &amp;ens_occ, const EigenVector&lt; typename Tile::scalar_type &gt; &amp;ens_uocc, typename Tile::numeric_type shift=0.0)</div><div class="ttdef"><b>Definition</b> solvers.h:130</div></div>
<div class="ttc" id="anamespacempqc_1_1lcao_1_1f12_1_1detail_html_a535e5eb60efb5e9a44087e975f4be2a0"><div class="ttname"><a href="namespacempqc_1_1lcao_1_1f12_1_1detail.html#a535e5eb60efb5e9a44087e975f4be2a0">mpqc::lcao::f12::detail::norm</a></div><div class="ttdeci">double norm(const std::vector&lt; double &gt; &amp;vec)</div><div class="ttdef"><b>Definition</b> f12_utility.cpp:73</div></div>
<div class="ttc" id="anamespacempqc_1_1lcao_1_1pno_html_aca75fda259db2f33dd3cea93e42e57e6"><div class="ttname"><a href="namespacempqc_1_1lcao_1_1pno.html#aca75fda259db2f33dd3cea93e42e57e6">mpqc::lcao::pno::Array</a></div><div class="ttdeci">TA::DistArray&lt; Tile, Policy &gt; Array</div><div class="ttdef"><b>Definition</b> types.h:25</div></div>
<div class="ttc" id="anamespacempqc_1_1python_1_1wfn_html_a7ffe093899ab36aa030acff882148cb6"><div class="ttname"><a href="namespacempqc_1_1python_1_1wfn.html#a7ffe093899ab36aa030acff882148cb6">mpqc::python::wfn::lcao_factory</a></div><div class="ttdeci">std::shared_ptr&lt; LCAOFactory &gt; lcao_factory(std::shared_ptr&lt; LCAOWavefunction &gt; wfn)</div><div class="ttdef"><b>Definition</b> wfn.h:77</div></div>
<div class="ttc" id="anamespacempqc_html"><div class="ttname"><a href="namespacempqc.html">mpqc</a></div><div class="ttdoc">The top-level namespace for all Massively Parallel Quantum Chemistry package.</div><div class="ttdef"><b>Definition</b> libmpqc.cpp:1</div></div>
<div class="ttc" id="anamespacempqc_html_aaa3f73986ae03e52631704f309d40bf7"><div class="ttname"><a href="namespacempqc.html#aaa3f73986ae03e52631704f309d40bf7">mpqc::indent</a></div><div class="ttdeci">std::basic_ios&lt; Char &gt; &amp; indent(std::basic_ios&lt; Char &gt; &amp;o)</div><div class="ttdef"><b>Definition</b> formio.impl.h:281</div></div>
<div class="ttc" id="anamespacempqc_html_afa2c03b81aadce4ea1aabb0ba2860cc2"><div class="ttname"><a href="namespacempqc.html#afa2c03b81aadce4ea1aabb0ba2860cc2">mpqc::nocc</a></div><div class="ttdeci">auto nocc(const PopulatedSparseOrbitalRange &amp;poporbs)</div><div class="ttdef"><b>Definition</b> orb.h:206</div></div>
<div class="ttc" id="arhf_8h_html"><div class="ttname"><a href="rhf_8h.html">rhf.h</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="devsampmp2mak"></a>
MP2 Implementation Example: CMakeLists.txt</h3>
<p>Although it is possible to build our example manually, or use Make, it is recommended to use CMake. This is because KitWare's CMake tool is used to configure, build, and install MPQC itself. Installing MPQC will export key information about the MPQC libraries and other prerequisites (e.g., TiledArray and MADWorld runtime) that is necessary to compile the code against them (e.g., the interlibrary dependencies, the compiler and linker flags, etc.). This exported info then makes it incredibly easy to use CMake to build our example in a few lines of CMake code. This file, located at <code>doc/dev/examples/mp2/CMakeLists.txt</code> in the MPQC build directory, was generated from the <a href="https://github.com/ValeevGroup/mpqc4/blob/master/doc/dev/examples/mp2/CMakeLists.txt.in"><code>doc/dev/examples/mp2/CMakeLists.txt.in</code></a> template located in the MPQC source directory.</p>
<p>The CMakeLists.txt file illustrates how to compile the <code><a class="el" href="mp2_8cpp.html">mp2.cpp</a></code> source and use it to create the <code>mp2</code> executable by linking against MPQC libraries. Note that the MPQC library names do not appear explicitly: instead we use their CMake target <code>MPQCmain</code> .</p>
<div class="fragment"><div class="line">set(program mp2)</div>
<div class="line"> </div>
<div class="line">cmake_minimum_required(VERSION )</div>
<div class="line">project(${program} LANGUAGES CXX)</div>
<div class="line"> </div>
<div class="line"># Import MPQC package from <span class="keyword">this</span> location</div>
<div class="line">list(APPEND CMAKE_PREFIX_PATH <span class="stringliteral">&quot;/usr/local&quot;</span>)</div>
<div class="line"><span class="preprocessor"># MPQCmain provides MPQC&#39;s main and the full MPQC functionality as its prereq (omit if roll your own)</span></div>
<div class="line">find_package(<a class="code hl_namespace" href="namespacempqc.html">mpqc</a>  CONFIG QUIET REQUIRED COMPONENTS MPQCmain)</div>
<div class="line">include(<span class="stringliteral">&quot;/usr/local/lib/cmake/mpqc/modules/AddMPQCExecutable.cmake&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># add the executable</span></div>
<div class="line"><span class="preprocessor"># mp2 uses MPQC main and thus links in all classes that the MPQC main links in</span></div>
<div class="line"><span class="preprocessor"># to customize the included functionality you will need to provide your own main</span></div>
<div class="line">add_mpqc_executable(${program} <span class="stringliteral">&quot;${program}.cpp&quot;</span> <span class="stringliteral">&quot;MPQCmain&quot;</span>)</div>
</div><!-- fragment --><h3><a class="anchor" id="devsampmp2inp"></a>
MP2 Implementation Example: Input</h3>
<p>This input JSON file can be used with the program illustrated in the <a class="el" href="develop.html#devsampmp2src">MP2 Implementation Example: Source</a> section.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="stringliteral">&quot;property&quot;</span> : {</div>
<div class="line">    <span class="stringliteral">&quot;type&quot;</span> : <span class="stringliteral">&quot;Energy&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;wfn&quot;</span> : <span class="stringliteral">&quot;$:mp2&quot;</span></div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;mp2&quot;</span>:{</div>
<div class="line">    <span class="stringliteral">&quot;type&quot;</span>: <span class="stringliteral">&quot;MP2&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;frozen_core&quot;</span> : <span class="keyword">true</span>,</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span> : <span class="stringliteral">&quot;$:water&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;wfn_world&quot;</span> : <span class="stringliteral">&quot;$:wfn_world&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;ref&quot;</span> : <span class="stringliteral">&quot;$:rhf&quot;</span></div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;wfn_world&quot;</span>:{</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span> : <span class="stringliteral">&quot;$:water&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;basis&quot;</span> : <span class="stringliteral">&quot;$:basis&quot;</span></div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;rhf&quot;</span>:{</div>
<div class="line">    <span class="stringliteral">&quot;type&quot;</span>: <span class="stringliteral">&quot;RHF&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span> : <span class="stringliteral">&quot;$:water&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;wfn_world&quot;</span> : <span class="stringliteral">&quot;$:wfn_world&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;localize&quot;</span> : <span class="keyword">true</span>,</div>
<div class="line">    <span class="stringliteral">&quot;localize_core&quot;</span> : <span class="keyword">false</span></div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;water&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span>: [</div>
<div class="line">      { <span class="stringliteral">&quot;element&quot;</span>: <span class="stringliteral">&quot;O&quot;</span>, <span class="stringliteral">&quot;xyz&quot;</span>:[ 0.00000, -0.07579,  0.00000] },</div>
<div class="line">      { <span class="stringliteral">&quot;element&quot;</span>: <span class="stringliteral">&quot;H&quot;</span>, <span class="stringliteral">&quot;xyz&quot;</span>:[ 0.86681,  0.60144,  0.00000] },</div>
<div class="line">      { <span class="stringliteral">&quot;element&quot;</span>: <span class="stringliteral">&quot;H&quot;</span>, <span class="stringliteral">&quot;xyz&quot;</span>:[-0.86681,  0.60144,  0.00000] }</div>
<div class="line">    ]</div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;basis&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;name&quot;</span>: <span class="stringliteral">&quot;6-31G&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span>: <span class="stringliteral">&quot;$:water&quot;</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="develop-outside-mpqc"></a>
Using MPQC as an external library in a separate project</h1>
<p>To use MPQC from a standalone project it is necessary to compile MPQC libraries and install them to the location specifies by the <code>CMAKE_INSTALL_PREFIX</code> CMake variable. It is recommended that the MPQC is validated before installation.</p>
<p>To use the MPQC code your program must do the following before using any nontrivial MPQC functionality:</p><ul>
<li>initialize the MADWorld parallel runtime + miscellaneous TiledArray runtime components (e.g. CUDA streams, memory pools), by calling <code>TA::initialize</code>() ; this will initialize the MPI runtime by calling MPI_Init_thread ;</li>
<li>initialize the MPQC package and the dependent components (e.g., the Libint2 Gaussian integral library) by calling <a class="el" href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97" title="Static MPQC initializer. Must be called from the main thread of every process in the default MADWorld...">mpqc::initialize()</a>;</li>
</ul>
<p>Here's a brief example: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mpqc__init_8h.html">mpqc/mpqc_init.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="comment">// initialize MADWorld + TiledArray runtime components</span></div>
<div class="line">  <span class="keyword">auto</span>&amp; world = TA::initialize(argc, argv);</div>
<div class="line">  <span class="comment">// initialize MPQC to use world as the execution context</span></div>
<div class="line">  <a class="code hl_function" href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97">mpqc::initialize</a>(argc, argv, world);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// use MPQC here</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// finalize MPQC</span></div>
<div class="line">  <a class="code hl_function" href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a">mpqc::finalize</a>();</div>
<div class="line">  <span class="comment">// finalize MADWorld + TiledArray</span></div>
<div class="line">  TA::finalize();</div>
<div class="line">}</div>
<div class="ttc" id="agroup___init_html_ga2587a14fd07ae77c0c51e5d64fd66d97"><div class="ttname"><a href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97">mpqc::initialize</a></div><div class="ttdeci">madness::World &amp; initialize(int &amp;argc, char **argv, madness::World &amp;top_world, std::shared_ptr&lt; GetLongOpt &gt; opt)</div><div class="ttdoc">Static MPQC initializer. Must be called from the main thread of every process in the default MADWorld...</div><div class="ttdef"><b>Definition</b> mpqc_init.cpp:80</div></div>
<div class="ttc" id="agroup___init_html_gae6fc4ad046972e6dc2a61fa64b069e9a"><div class="ttname"><a href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a">mpqc::finalize</a></div><div class="ttdeci">void finalize()</div><div class="ttdoc">Finalize MPQC.</div><div class="ttdef"><b>Definition</b> mpqc_init.cpp:128</div></div>
<div class="ttc" id="ampqc_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition</b> mpqc.cpp:416</div></div>
<div class="ttc" id="ampqc__init_8h_html"><div class="ttname"><a href="mpqc__init_8h.html">mpqc_init.h</a></div></div>
</div><!-- fragment --><p> Note that there are more elaborate use cases that we do not discuss here, e.g., it is possible to initialize MADWorld using a communicator other than <code>MPI_COMM_WORLD</code>; please see the documentation for <code>TA::initialize()</code>.</p>
<p>After the MPQC functionality is no longer needed, you can release resources by calling <a class="el" href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a" title="Finalize MPQC.">mpqc::finalize()</a> . This is not necessary if you are about to exit the program: the MPQC resources are released automatically when the program exits. Note that it is possible to call <a class="el" href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97" title="Static MPQC initializer. Must be called from the main thread of every process in the default MADWorld...">mpqc::initialize()</a> again after calling <a class="el" href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a" title="Finalize MPQC.">mpqc::finalize()</a>. Function <a class="el" href="group___init.html#ga77d8648c91824ba67958cd5f9eae8034">mpqc::initialized()</a> can be used to query whether MPQC is currently initialized.</p>
<p>After the MADWorld runtime is no longer needed, it is recommended to call <code>TA::finalize</code>() . You should not call <code>TA::initialize</code>() again after calling <code>TA::finalize</code>() because the MPI Standard does not specify whether the MPI libraries must support more than one initialize/finalize cycle.</p>
<p>Note that the most common use case is to initialize MADworld+TiledArray+MPQC all in one shot; for this purpose there is an <code>::mpqc::initialize(argc,argv)</code> overload that should be used as demonstrated here: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mpqc__init_8h.html">mpqc/mpqc_init.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="comment">// initialize MADWorld + TiledArray + MPQC runtime components, returns ref to the default World object</span></div>
<div class="line">  <span class="keyword">auto</span>&amp; world = <a class="code hl_function" href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97">mpqc::initialize</a>(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// compute in world ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// finalize MADWorld + TiledArray + MPQC runtime components</span></div>
<div class="line">  <a class="code hl_function" href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a">mpqc::finalize</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p> Note that is this combo-overload of <code><a class="el" href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97" title="Static MPQC initializer. Must be called from the main thread of every process in the default MADWorld...">mpqc::initialize</a></code> has been called, <code><a class="el" href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a" title="Finalize MPQC.">mpqc::finalize()</a></code> finalizes MADWorld as well; since MADWorld just like MPI can only be finalized once it is not possible to initialize MPQC again in this scenario.</p>
<h2><a class="anchor" id="devsampaoints"></a>
AOInts Implementation Example</h2>
<p>To illustrate how to use the plug-out approach let's consider a simple example in which we use MPQC functionality to compute 2-body Coulomb integrals with brakets constisting of 2, 3, and 4 atomic orbitals (in the quantum chemistry context these are referred to as 2-, 3-, and 4-center electron repulsion integrals). The 2- and 3-index integrals are used to approximate the 4-center integrals by density fitting, which involves some simple tensor algebra.</p>
<h3><a class="anchor" id="devsampaointssrc"></a>
AOInts Implementation Example: Source</h3>
<p>This example code illustrates how to construct TiledArray tensors of AO integrals using the MPQC Toolkit. The source file can be found at <a href="https://github.com/ValeevGroup/mpqc4/blob/master/doc/dev/examples/aoints/aoints.cpp"><code>doc/dev/examples/aoints/aoints.cpp</code></a> in the MPQC source directory. Note that the source file does contain the <code><a class="el" href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a></code> function which explicitly includes all steps needed to initialize MPQC.</p>
<p>To compile the new class and link into the MPQC executable see the <a class="el" href="develop.html#devsampaointsmak">AOInts Implementation Example: CMakeLists.txt</a> section.</p>
<div class="fragment"><div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Created by Eduard Valeyev on 8/13/18.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;madness/world/worldgop.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;clocale&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tiledarray_8h.html">mpqc/math/external/tiledarray/tiledarray.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ao__factory_8h.html">mpqc/chemistry/qc/lcao/factory/ao_factory.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="mpqc__init_8h.html">mpqc/mpqc_init.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="exenv_8h.html">mpqc/util/core/exenv.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="src_2mpqc_2util_2keyval_2keyval_8h.html">mpqc/util/keyval/keyval.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="chemistry_2qc_2lcao_2factory_2linkage_8h.html">mpqc/chemistry/qc/lcao/factory/linkage.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="keyword">auto</span>&amp; world = <a class="code hl_function" href="group___init.html#ga2587a14fd07ae77c0c51e5d64fd66d97">mpqc::initialize</a>(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::string input_filename = <span class="stringliteral">&quot;aoints.json&quot;</span>;</div>
<div class="line">  <a class="code hl_function" href="classmpqc_1_1_m_p_q_c_init.html#aca9e53b2bc42116bae01ba6426eeb4a5">mpqc::MPQCInit::instance</a>().<a class="code hl_function" href="classmpqc_1_1_m_p_q_c_init.html#a32d320a547be460d93cd7e4e7fce1ec9">init_io</a>(input_filename);</div>
<div class="line">  std::shared_ptr&lt;mpqc::KeyVal&gt; kv =</div>
<div class="line">      <a class="code hl_function" href="classmpqc_1_1_m_p_q_c_init.html#aca9e53b2bc42116bae01ba6426eeb4a5">mpqc::MPQCInit::instance</a>().<a class="code hl_function" href="classmpqc_1_1_m_p_q_c_init.html#a692c43b48a607149b184691cc69ab12a">make_keyval</a>(world, input_filename);</div>
<div class="line">  kv-&gt;assign(<span class="stringliteral">&quot;world&quot;</span>,</div>
<div class="line">             &amp;world);  <span class="comment">// set &quot;$:world&quot; keyword to &amp;world to define the</span></div>
<div class="line">                       <span class="comment">// default execution context for this input</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using </span><a class="code hl_class" href="classmpqc_1_1lcao_1_1gaussian_1_1_a_o_factory.html">mpqc::lcao::gaussian::AOFactory</a>;</div>
<div class="line">  <span class="keyword">auto</span> aofactory =</div>
<div class="line">      std::make_shared&lt;AOFactory&lt;TA::TensorD, TA::SparsePolicy&gt;&gt;(*kv);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> eri4 = aofactory-&gt;<a class="code hl_function" href="classmpqc_1_1lcao_1_1gaussian_1_1_a_o_factory.html#a8ab292ab2eff02e1be7db163e926c91f">compute</a>(L<span class="stringliteral">&quot;( | G | )&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eri3 = aofactory-&gt;compute(L<span class="stringliteral">&quot;(  | G | )&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eri2 = aofactory-&gt;compute(L<span class="stringliteral">&quot;(  | G |  )&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> eri2_sqrt_inv = aofactory-&gt;compute(L<span class="stringliteral">&quot;(  | G |  )[inv_sqr]&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// test eri2_sqrt_inv</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">auto</span> <a class="code hl_typedef" href="namespacempqc.html#a353cbaa14255ed1807b5c8e856515eb5">identity</a> =</div>
<div class="line">        TA::diagonal_array&lt;TA::TSpArrayD&gt;(eri2.world(), eri2.trange(), 1.0);</div>
<div class="line">    TA::TSpArrayD zero;</div>
<div class="line">    zero(<span class="stringliteral">&quot;m,l&quot;</span>) = <a class="code hl_typedef" href="namespacempqc.html#a353cbaa14255ed1807b5c8e856515eb5">identity</a>(<span class="stringliteral">&quot;m,l&quot;</span>) -</div>
<div class="line">                  eri2(<span class="stringliteral">&quot;m,n&quot;</span>) * eri2_sqrt_inv(<span class="stringliteral">&quot;n,k&quot;</span>) * eri2_sqrt_inv(<span class="stringliteral">&quot;k,l&quot;</span>);</div>
<div class="line">    <a class="code hl_function" href="classmpqc_1_1_ex_env.html#a9bff86d8c41e9444060de6c717df18c0">mpqc::ExEnv::out0</a>() &lt;&lt; <span class="stringliteral">&quot;testing V^{-1/2}: this should be zero = &quot;</span></div>
<div class="line">                        &lt;&lt; TA::norm2(zero) &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// test DF reconstruction of eri4</span></div>
<div class="line">  {</div>
<div class="line">    TA::TSpArrayD B;</div>
<div class="line">    B(<span class="stringliteral">&quot;K,p,q&quot;</span>) = eri2_sqrt_inv(<span class="stringliteral">&quot;K,X&quot;</span>) * eri3(<span class="stringliteral">&quot;X,p,q&quot;</span>);</div>
<div class="line">    TA::TSpArrayD dferror4;</div>
<div class="line">    dferror4(<span class="stringliteral">&quot;p,q,r,s&quot;</span>) = eri4(<span class="stringliteral">&quot;p,q,r,s&quot;</span>) - B(<span class="stringliteral">&quot;K,p,q&quot;</span>) * B(<span class="stringliteral">&quot;K,r,s&quot;</span>);</div>
<div class="line">    <a class="code hl_function" href="classmpqc_1_1_ex_env.html#a9bff86d8c41e9444060de6c717df18c0">mpqc::ExEnv::out0</a>() &lt;&lt; <span class="stringliteral">&quot;testing DF: this should be small (and decrease &quot;</span></div>
<div class="line">                           <span class="stringliteral">&quot;with increasing DF basis) = &quot;</span></div>
<div class="line">                        &lt;&lt; TA::norm2(dferror4) &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="group___init.html#gae6fc4ad046972e6dc2a61fa64b069e9a">mpqc::finalize</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aao__factory_8h_html"><div class="ttname"><a href="ao__factory_8h.html">ao_factory.h</a></div></div>
<div class="ttc" id="achemistry_2qc_2lcao_2factory_2linkage_8h_html"><div class="ttname"><a href="chemistry_2qc_2lcao_2factory_2linkage_8h.html">linkage.h</a></div></div>
<div class="ttc" id="aclassmpqc_1_1_ex_env_html_a9bff86d8c41e9444060de6c717df18c0"><div class="ttname"><a href="classmpqc_1_1_ex_env.html#a9bff86d8c41e9444060de6c717df18c0">mpqc::ExEnv::out0</a></div><div class="ttdeci">static std::ostream &amp; out0()</div><div class="ttdef"><b>Definition</b> exenv.cpp:104</div></div>
<div class="ttc" id="aclassmpqc_1_1_m_p_q_c_init_html_a32d320a547be460d93cd7e4e7fce1ec9"><div class="ttname"><a href="classmpqc_1_1_m_p_q_c_init.html#a32d320a547be460d93cd7e4e7fce1ec9">mpqc::MPQCInit::init_io</a></div><div class="ttdeci">void init_io(const std::string &amp;input_filename={}, const std::string &amp;output_filename={}, const std::string &amp;basename={}, int reals_cpp_stream_precision=std::numeric_limits&lt; double &gt;::max_digits10)</div><div class="ttdoc">Initialize formatted I/O (i.e., the FormIO class ).</div><div class="ttdef"><b>Definition</b> mpqc_init.cpp:384</div></div>
<div class="ttc" id="aclassmpqc_1_1_m_p_q_c_init_html_a692c43b48a607149b184691cc69ab12a"><div class="ttname"><a href="classmpqc_1_1_m_p_q_c_init.html#a692c43b48a607149b184691cc69ab12a">mpqc::MPQCInit::make_keyval</a></div><div class="ttdeci">std::shared_ptr&lt; mpqc::KeyVal &gt; make_keyval(madness::World &amp;world, const std::string &amp;filename)</div><div class="ttdef"><b>Definition</b> mpqc_init.cpp:377</div></div>
<div class="ttc" id="aclassmpqc_1_1_m_p_q_c_init_html_aca9e53b2bc42116bae01ba6426eeb4a5"><div class="ttname"><a href="classmpqc_1_1_m_p_q_c_init.html#aca9e53b2bc42116bae01ba6426eeb4a5">mpqc::MPQCInit::instance</a></div><div class="ttdeci">static MPQCInit &amp; instance()</div><div class="ttdef"><b>Definition</b> mpqc_init.cpp:288</div></div>
<div class="ttc" id="aclassmpqc_1_1lcao_1_1gaussian_1_1_a_o_factory_html"><div class="ttname"><a href="classmpqc_1_1lcao_1_1gaussian_1_1_a_o_factory.html">mpqc::lcao::gaussian::AOFactory</a></div><div class="ttdoc">Gaussian AO integral factory using ab initio Hamiltonians.</div><div class="ttdef"><b>Definition</b> ao_factory.h:190</div></div>
<div class="ttc" id="aclassmpqc_1_1lcao_1_1gaussian_1_1_a_o_factory_html_a8ab292ab2eff02e1be7db163e926c91f"><div class="ttname"><a href="classmpqc_1_1lcao_1_1gaussian_1_1_a_o_factory.html#a8ab292ab2eff02e1be7db163e926c91f">mpqc::lcao::gaussian::AOFactory::compute</a></div><div class="ttdeci">TArray compute(const Formula &amp;formula) override</div><div class="ttdef"><b>Definition</b> ao_factory.ipp:196</div></div>
<div class="ttc" id="aexenv_8h_html"><div class="ttname"><a href="exenv_8h.html">exenv.h</a></div></div>
<div class="ttc" id="anamespacempqc_html_a353cbaa14255ed1807b5c8e856515eb5"><div class="ttname"><a href="namespacempqc.html#a353cbaa14255ed1807b5c8e856515eb5">mpqc::identity</a></div><div class="ttdeci">std::identity identity</div><div class="ttdef"><b>Definition</b> functional:11</div></div>
<div class="ttc" id="asrc_2mpqc_2util_2keyval_2keyval_8h_html"><div class="ttname"><a href="src_2mpqc_2util_2keyval_2keyval_8h.html">keyval.h</a></div></div>
<div class="ttc" id="atiledarray_8h_html"><div class="ttname"><a href="tiledarray_8h.html">tiledarray.h</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="devsampaointsmak"></a>
AOInts Implementation Example: CMakeLists.txt</h3>
<p>Just like with the MP2 example, it is recommended to use CMake to build this example. See file <code>doc/dev/examples/aoints/CMakeLists.txt</code> located in the MPQC build directory that was generated from the <a href="https://github.com/ValeevGroup/mpqc4/blob/master/doc/dev/examples/aoints/CMakeLists.txt.in"><code>doc/dev/examples/aoints/CMakeLists.txt.in</code></a> template located in the MPQC source directory.</p>
<p>The CMakeLists.txt file illustrates how to compile the <code>aoints.cpp</code> source and use it to create the <code>aoints</code> executable by linking against MPQC libraries. Note that the MPQC library names do not appear explicitly: instead we use their CMake target <code>libmpqc</code> (unlike the CMake target <code>MPQCmain</code> that we used previously, <code>libmpqc</code> does not include MPQC's <code><a class="el" href="mpqc_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a></code> function ).</p>
<div class="fragment"><div class="line">set(program aoints)</div>
<div class="line"> </div>
<div class="line">cmake_minimum_required(VERSION )</div>
<div class="line">project(${program} LANGUAGES CXX)</div>
<div class="line"> </div>
<div class="line"># Import MPQC package from <span class="keyword">this</span> location</div>
<div class="line">list(APPEND CMAKE_PREFIX_PATH <span class="stringliteral">&quot;/usr/local&quot;</span>)</div>
<div class="line">find_package(<a class="code hl_namespace" href="namespacempqc.html">mpqc</a>  CONFIG QUIET REQUIRED COMPONENTS libmpqc)</div>
<div class="line">include(<span class="stringliteral">&quot;/usr/local/lib/cmake/mpqc/modules/AddMPQCExecutable.cmake&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># add the executable</span></div>
<div class="line">add_mpqc_executable(${program} <span class="stringliteral">&quot;${program}.cpp&quot;</span> <span class="stringliteral">&quot;libmpqc&quot;</span>)</div>
</div><!-- fragment --><h3><a class="anchor" id="devsampaointsinp"></a>
AOInts Implementation Example: Input</h3>
<p>This input JSON file can be used with the program illustrated in the <a class="el" href="develop.html#devsampaointssrc">AOInts Implementation Example: Source</a> section.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="stringliteral">&quot;wfn_world&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span> : <span class="stringliteral">&quot;$:water&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;basis&quot;</span>: {</div>
<div class="line">      <span class="stringliteral">&quot;name&quot;</span>: <span class="stringliteral">&quot;6-31G&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;atoms&quot;</span>: <span class="stringliteral">&quot;$:water&quot;</span></div>
<div class="line">    },</div>
<div class="line">    <span class="stringliteral">&quot;df_basis&quot;</span>: {</div>
<div class="line">      <span class="stringliteral">&quot;name&quot;</span>: <span class="stringliteral">&quot;aug-cc-pVDZ&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;atoms&quot;</span>: <span class="stringliteral">&quot;$:water&quot;</span></div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;water&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;atoms&quot;</span>: [</div>
<div class="line">      { <span class="stringliteral">&quot;element&quot;</span>: <span class="stringliteral">&quot;O&quot;</span>, <span class="stringliteral">&quot;xyz&quot;</span>:[ 0.00000, -0.07579,  0.00000] },</div>
<div class="line">      { <span class="stringliteral">&quot;element&quot;</span>: <span class="stringliteral">&quot;H&quot;</span>, <span class="stringliteral">&quot;xyz&quot;</span>:[ 0.86681,  0.60144,  0.00000] },</div>
<div class="line">      { <span class="stringliteral">&quot;element&quot;</span>: <span class="stringliteral">&quot;H&quot;</span>, <span class="stringliteral">&quot;xyz&quot;</span>:[-0.86681,  0.60144,  0.00000] }</div>
<div class="line">    ]</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The contents of this file are used to construct a KeyVal object used to construct MPQC infrastructure classes; since it is possible to construct KeyVal objects programmatically, it is not necessary to use input files, but here we use it for simplicity. It is, for example, possible to change the basis sets in this file without needing to recompile the <code>aoints</code> program.</p>
<h1><a class="anchor" id="devmpqcnotes"></a>
Additional notes on development within and with MPQC.</h1>
<h2><a class="anchor" id="devmpqcnotescompiletime"></a>
Reducing compile time</h2>
<p>Due to the design of C++, compiling C++ programs can be time- and resource-intensive. <a href="https://xkcd.com/303/">It is a common misconception that you are working when your code is being compiled</a>. Some improvements are on the way (e.g. Modules in C++20) but for the foreseeable future reducing compilation resource requirements falls on the developer, by <em>designing</em> for compile times and by utilizing special build techniques. Below you will find some tips on how to the compile times of MPQC and MPQC-dependent codes.</p>
<h3><a class="anchor" id="devmpqcnotescompiletimegen"></a>
Generic recommendations for reducing compile times</h3>
<ul>
<li>Use RAM disk to compile as well as for IDE (e.g. CLion) to keep its wares. See <a href="https://github.com/zafarella/OSX-RAMDisk">https://github.com/zafarella/OSX-RAMDisk</a> for a fancy script that will move caches for various apps (including CLion) or just google ramdisk macos. To tell the compiler to use RAM disk you need to set the environment variable <code>TMPDIR</code> (Preferences-&gt;Build,Execution,Deployment-&gt;CMake then edit Environment) to point to a directory in ramdisk, e.g. set <code>TMPDIR</code> to <code>/Users/yourname/ramdisk/Clion</code></li>
<li>Use Ninja (instead of GNU Make) to speed up builds. It may not speed up the template heavy C++ code in MPQC by much, but its ability to accurately compute prerequisites for targets is key to making the next idea work well. If you use the CLion IDE, note that Ninja (and other non-Make) generator support was introduced in CLion 2019.3!</li>
<li>Use a faster compiler. Clang is often faster than GCC at compiling code (but this != "produces faster code"). You can even squeeze out top performance from your C++ compiler by recompiling it with profile-guided optimizations.</li>
<li>Set up a compile farm.</li>
</ul>
<p>These are just few examples; for a more thorough discussion please see <a href="http://www.bitsnbites.eu/faster-c-builds/">http://www.bitsnbites.eu/faster-c-builds/</a> .</p>
<h3><a class="anchor" id="devmpqcnotescompiletimempqc"></a>
MPQC-specific recommendations for reducing compile times</h3>
<ul>
<li>When developing within MPQC it is recommended to make a unit test for the feature you are working on, and then compile that unit test only. Currently MPQCs unit tests are all integrated into a single executable <code>unit_tests</code>, so you want to trim the list of source files included in that executable; edit CMake variable <code>utests_src</code> in <code>tests/unit/CMakeLists.txt</code>.</li>
<li>If to test your work you cannot unit test and you need to run the <code>mpqc</code> executable, unless you must run a feature that integrates almost everything in MPQC (e.g. CCSD-F12) you can still drastically reduce the time it takes to build <code>mpqc</code> by trimming down the MPQC feature list. This is particularly important when you work on heavily reused features (i.e. you are modifying files that are included by many other files). To trim it set the <code>MPQC_FEATURES</code> CMake cache variable to the minimum list of features you need, e.g., to only compile mean-field methods add <code>-DMPQC_FEATURES="lcao_scf"</code> to the CMake command line. Figuring out the shortest <code>MPQC_FEATURES</code> that you need may require some experimentation, but it will be worth it; see <code>src/bin/mpqc/CMakeLists.txt</code> for more details. N.B. It seems that even with a trimmed-down <code>MPQC_FEATURES</code> all libraries are compiled the first time you build MPQC, <em>unless</em> you use Ninja, which can properly deduce the correct list of dependencies for the <code>mpqc</code> executable. So it is another reason to use Ninja.</li>
<li>Ask cmake to enable <a href="https://cmake.org/cmake/help/latest/prop_tgt/UNITY_BUILD.html">unity builds</a> for MPQC (and any other components built as part of MPQC) by giving it <code>-DCMAKE_UNITY_BUILD=ON</code>. Unity builds are especially recommended for complete* (as opposed to incremental) builds of MPQC (e.g. if you are working on low-level features that touch most of the code so that almost all MPQC libraries are rebuilt every time); if you only touch a particular top-level source file unity builds may actually make incremental recompilation slower. Also, unity builds will stress your compiler so stick with Clang if you want to use them; variable <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_UNITY_BUILD_BATCH_SIZE.html"><code>CMAKE_UNITY_BUILD_BATCH_SIZE</code></a> can be used to control the granularity of the unity targets to manage the resource requirements.</li>
<li>Choose your build target wisely. Most of the time there is no need to build the executable to test the latest rounds of changes, it's sufficient to build a library that has .cpp files that use your feature. E.g. when changing something in <code>lcao/scf</code> I would just build <code>MPQClcao_scf-obj</code> target to test it. Note the <code>-obj</code> suffix: this ensures that transitive dependencies are ignored. This is important when you are tweaking something in the core of MPQC and you just want whether it breaks the simplest wavefunction class (e.g. <code>RHF</code>). Compiling the <em>object</em> SCF library builds <em>only</em> the SCF-related files, and avoids rebuilding libraries that <code>MPQClcao_scf</code> depends on (i.e. all libraries in <code>util</code> and <code>math</code>, and most libraries in <code>chemistry</code>). </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 13 2025 23:43:46 for MPQC-Docs by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
